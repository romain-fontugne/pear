{% extends 'base.html' %}

{% block head %}
<title>{{country_name}} ({{cc}})</title>
{% endblock %}

{% block body %}
{% if cc == None %}

    <div class="row">
        <div class="col-8">
            <div id="countryDropdown" >
                <input type="text" placeholder="Search..." id="searchCountry" 
                onkeyup="filterFunction('searchCountry', 'countryDropdown')"
                class="form-control">
                {% for cc, name in all_country_code.items() %}
                <a class="dropdown-item" href="/country?cc={{cc}}">{{name}} ({{cc}})</a>
                {% endfor %}
            </div>
        </div>
    </div>

{% else %}
<h1>{{country_name}}</h1>

{% if flows %}
<h2>Traffic Overview</h2>
<div class='row'>
    <div class='col'>
        <div id="trafficASNPlot"></div>
    </div>
</div>
{% endif %}

{% if traceroutes %}
<h2>RTT overview</h2>
RTT from Atlas probes via AS{{asn}}
<div class='row'>
    <div class='col'>
        <div id="rttPlot"></div>
    </div>
</div>
{% endif %}
<h2>Traffic breakdown</h2>
<table id="trafficTable" class="table table-striped table-sm table-hover" width="100%">
    <thead>
    <tr>
        <th>Router</th>
        <th>Origin AS</th>
        <th>Prefix</th>
        <th>Traffic Volume</th>
        <th>Country</th>
        <th>AS path</th>
        <th>Description</th>
        <th>Country Name</th>
        <th>Origin AS Name</th>
    </tr>
    </thead>
    <tbody>
    {% for router_name, traffic in flows.items() %}
      {% for prefix, data in traffic.items() %}
        <tr>
            <td>{{ router_name }}</td>
            <td>{{ data.info.originasn }}</td>
            <td>{{ prefix }}</td>
            <td>{{ data.vol }}</td>
            <td>{{ data.info.country }}</td>
            <td>
                {{ ' - '.join(data.info.aspath) }}
            </td>
            <td>{{ data.info.descr }}</td>
            <td>{{ data.info.country_name }}</td>
            <td>{{ data.info.originasn_name }}</td>
        </tr>
      {% endfor %}
    {% endfor %}
    </tbody>
</table>

<h2>RTT</h2>

<table id="rttTable" class="table table-striped table-sm table-hover" width="100%">
    <thead>
    <tr>
        <th>Probe ID</th>
        <th>Country</th>
        <th>ASN </th>
        <th>router </th>
        <th>AS path</th>
        <th>Min. RTT</th>
        <th>Med. RTT</th>
        <th>Max. RTT</th>
        <th>Nb. samples</th>
    </tr>
    </thead>
    <tbody>
        {% for pid, asn, country, aspath, af, router, nb_samples, min_rtt, med_rtt, max_rtt in traceroutes %}
                <tr>
                    <td>{{ pid }}</td>
                    <td>{{ country }}</td>
                    <td>{{ asn }}</td>
                    <td>{{ router }}</td>
                    <td> {{ aspath }} </td>
                    <td> {{ min_rtt }} </td>
                    <td> {{ med_rtt }} </td>
                    <td> {{ max_rtt }} </td>
                    <td> {{ nb_samples }} </td>
                </tr>
        {% endfor %}
    </tbody>
</table>


{% endif %}
{% endblock %}

{% block footer %}
<script type="text/javascript">

    $(document).ready(function () {
        var trafficDataTable = $('#trafficTable').DataTable({
            paging: false,
            scrollY:        '50vh',
            scrollCollapse: true,
            columnDefs: [
                {
                    targets: [ 0 ],
                    render: renderRouter
                },
                {
                    targets: [ 1 ],
                    render: renderASN
                },
                {
                    targets: [ 4 ],
                    render: renderCountry
                },
                {
                    targets: [ 5 ],
                    render: renderASpath
                },
                {
                    targets: [ 7, 8 ],
                    visible: false,
                },
                { 
                    targets: [ 3 ],
                    type: "traffic",
                    render: renderTraffic
                }
            ],
        });
        drawTraffic(trafficDataTable, 'trafficASNPlot', 'Origin AS');

        var rttTable = $('#rttTable').DataTable({
            paging: false,
            scrollY:        '50vh',
            scrollCollapse: true,
            columnDefs: [ 
                {
                    targets: [ 0 ],
                    render: renderAtlasProbe
                },
                {
                    targets: [ 1 ],
                    render: renderCountry
                },
                {
                    targets: [ 3 ],
                    render: renderRouter
                },
                {
                    targets: [ 2 ],
                    render: renderASN
                },
                {
                    targets: [ 4 ],
                    render: renderASpath
                },
            ]
        });

        $('.dataTables_length').addClass('bs-select');
        drawRtt(rttTable, 'rttPlot', '{{ cc }}');

    });
</script>
{% endblock %}
